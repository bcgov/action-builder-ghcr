name: PR

on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  attestations: write
  id-token: write
  packages: write

jobs:
  # QuickStart apps build from the same dirs as their Dockerfiles
  build:
    name: Build
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - id: build
        uses: ./
        with:
          package: backend
          keep_versions: 10
          repository: bcgov/quickstart-openshift

      - if: steps.build.outputs.triggered != 'false'
        run: |
          # Verify outputs
          echo "Outputs: ${{ toJSON(steps.build.outputs) }}"
          if [ -z "${{ steps.build.outputs.digest }}" ] || [ "${{ steps.build.outputs.triggered }}" != "true" ]; then
            echo "Error!  Verify outputs."
            exit 1
          fi
      
      - if: steps.build.outputs.triggered != 'false'
        env:
          PACKAGE_TAG: "action-builder-ghcr/backend:${{ github.event.number }}"
        run: |
          # Verify SLSA provenance and SBOM

          curl -O -L "https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64"
          chmod +x cosign-linux-amd64

          ./cosign-linux_amd64 verify-attestation \
            --certificate-identity-regexp "https://github.com/login/oauth" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            ghcr.io/bcgov/${PACKAGE_TAG}

          ./cosign-linux_amd64 verify-attestation \
            --type sbom \
            --certificate-identity-regexp "https://github.com/login/oauth" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            ghcr.io/bcgov/${PACKAGE_TAG}

  # No attestation, no id-token, no build
  no-attestation:
    name: No Attestation
    permissions:
      attestations: none
      id-token: none
      packages: write
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - id: no-attestation
        uses: ./
        with:
          package: frontend
          build_context: frontend
          keep_versions: 10
          repository: bcgov/quickstart-openshift
          tags: ${{ github.event.number }}-no-attestation
          tag_fallback: test
          triggers: ('frontend/')

      - if: steps.no-attestation.outputs.triggered != 'false'
        run: |
          # Verify outputs
          echo "Outputs: ${{ toJSON(steps.no-attestation.outputs) }}"
          if [ -z "${{ steps.no-attestation.outputs.digest }}" ] || [ "${{ steps.no-attestation.outputs.triggered }}" != "true" ]; then
            echo "Error!  Verify outputs."
            exit 1
          fi
      
      - if: steps.no-attestation.outputs.triggered != 'false'
        env:
          PACKAGE_TAG: "action-builder-ghcr/frontend:${{ github.event.number }}"
        run: |
          # Verify SLSA provenance and SBOM

          curl -O -L "https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64"
          chmod +x cosign-linux-amd64

          ./cosign-linux_amd64 verify-attestation \
            --certificate-identity-regexp "https://github.com/login/oauth" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            ghcr.io/bcgov/${PACKAGE_TAG}

          ./cosign-linux_amd64 verify-attestation \
            --type sbom \
            --certificate-identity-regexp "https://github.com/login/oauth" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            ghcr.io/bcgov/${PACKAGE_TAG}

  # FOM apps build from repo root, above their Dockerfiles (extra params)
  advanced:
    name: Advanced
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - id: advanced
        uses: ./
        with:
          package: api
          build_context: .
          build_file: api/Dockerfile
          keep_versions: 10
          repository: bcgov/nr-fom
          tags: |
            ${{ github.event.number }}
            ${{ github.event.number }}-multiline
            pr-latest

      - if: steps.advanced.outputs.triggered != 'false'
        run: |
          # Verify outputs
          echo "Outputs: ${{ toJSON(steps.advanced.outputs) }}"
          if [ -z "${{ steps.advanced.outputs.digest }}" ] || [ "${{ steps.advanced.outputs.triggered }}" != "true" ]; then
            echo "Error!  Verify outputs."
            exit 1
          fi
      
      - if: steps.advanced.outputs.triggered != 'false'
        env:
          PACKAGE_TAG: "action-builder-ghcr/api:${{ github.event.number }}"
        run: |
          # Verify SLSA provenance and SBOM

          curl -O -L "https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64"
          chmod +x cosign-linux-amd64
          
          ./cosign-linux_amd64 verify-attestation \
            --certificate-identity-regexp "https://github.com/login/oauth" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            ghcr.io/bcgov/${PACKAGE_TAG}

          ./cosign-linux_amd64 verify-attestation \
            --type sbom \
            --certificate-identity-regexp "https://github.com/login/oauth" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            ghcr.io/bcgov/${PACKAGE_TAG}

  # Test single-package repo format (no package in path)
  single-package:
    name: Single Package
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - id: single-package
        uses: ./
        with:
          package: action-builder-ghcr
          build_context: .
          build_file: ./Dockerfile  # Results in org/repo format since Dockerfile is in root
          repository: bcgov/nr-peach
          tags: |
            ${{ github.event.number }}
            single-package-test

      - if: steps.single-package.outputs.triggered != 'false'
        run: |
          # Verify outputs
          echo "Outputs: ${{ toJSON(steps.single-package.outputs) }}"
          if [ -z "${{ steps.single-package.outputs.digest }}" ] || [ "${{ steps.single-package.outputs.triggered }}" != "true" ]; then
            echo "Error!  Verify outputs."
            exit 1
          fi

      - if: steps.single-package.outputs.triggered != 'false'
        env:
          PACKAGE_TAG: "action-builder-ghcr:${{ github.event.number }}"
        run: |
          # Verify SLSA provenance and SBOM

          curl -O -L "https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64"
          chmod +x cosign-linux-amd64
          
          ./cosign-linux_amd64 verify-attestation \
            --certificate-identity-regexp "https://github.com/login/oauth" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            ghcr.io/bcgov/${PACKAGE_TAG}

          ./cosign-linux_amd64 verify-attestation \
            --type sbom \
            --certificate-identity-regexp "https://github.com/login/oauth" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            ghcr.io/bcgov/${PACKAGE_TAG}

  results:
    name: PR Results
    needs: [advanced, build, no-attestation, single-package]
    if: always()
    runs-on: ubuntu-24.04
    steps:
      - if: contains(needs.*.result, 'failure')||contains(needs.*.result, 'canceled')
        run: echo "At least one job has failed." && exit 1
      - run: echo "Success!"
