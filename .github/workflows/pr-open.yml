name: PR

on:
  pull_request:
  pull_request_target:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  attestations: write
  id-token: write
  packages: write

jobs:
  # QuickStart apps build from the same dirs as their Dockerfiles
  build:
    name: Build
    runs-on: ubuntu-24.04
    # Skip pull_request_target for same-repo PRs (pull_request handles those)
    # Skip pull_request for fork PRs (pull_request_target handles those)
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) ||
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name != github.repository)
    steps:
      - uses: actions/checkout@v6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
      - id: build
        uses: ./
        with:
          package: backend
          repository: bcgov/quickstart-openshift

      - if: steps.build.outputs.triggered != 'false'
        run: |
          # Verify outputs
          echo "Outputs: ${{ toJSON(steps.build.outputs) }}"
          if [ -z "${{ steps.build.outputs.digest }}" ] || [ "${{ steps.build.outputs.triggered }}" != "true" ]; then
            echo "Error!  Verify outputs."
            exit 1
          fi

  # No attestation, no id-token, no build
  no-attestation:
    name: No Attestation
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) ||
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name != github.repository)
    permissions:
      attestations: none
      id-token: none
      packages: write
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
      - id: no-attestation
        uses: ./
        with:
          package: frontend
          build_context: frontend
          repository: bcgov/quickstart-openshift
          tags: ${{ github.event.number }}-no-attestation
          tag_fallback: test
          triggers: ('frontend/')

      - if: steps.no-attestation.outputs.triggered != 'false'
        run: |
          # Verify outputs
          echo "Outputs: ${{ toJSON(steps.no-attestation.outputs) }}"
          if [ -z "${{ steps.no-attestation.outputs.digest }}" ] || [ "${{ steps.no-attestation.outputs.triggered }}" != "true" ]; then
            echo "Error!  Verify outputs."
            exit 1
          fi

  # FOM apps build from repo root, above their Dockerfiles (extra params)
  advanced:
    name: Advanced
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) ||
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name != github.repository)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
      - id: advanced
        uses: ./
        with:
          package: api
          build_context: .
          build_file: api/Dockerfile
          repository: bcgov/nr-fom
          tags: |
            ${{ github.event.number }}
            ${{ github.event.number }}-multiline
            pr-latest

  # Test single-package repo format (no package in path)
  single-package:
    name: Single Package
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) ||
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name != github.repository)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
      - id: single-package
        uses: ./
        with:
          package: action-builder-ghcr
          build_context: .
          build_file: ./Dockerfile # Results in org/repo format since Dockerfile is in root
          repository: bcgov/nr-peach
          tags: |
            ${{ github.event.number }}
            single-package-test

      - if: steps.single-package.outputs.triggered != 'false'
        run: |
          # Verify outputs
          echo "Outputs: ${{ toJSON(steps.single-package.outputs) }}"
          if [ -z "${{ steps.single-package.outputs.digest }}" ] || [ "${{ steps.single-package.outputs.triggered }}" != "true" ]; then
            echo "Error!  Verify outputs."
            exit 1
          fi

  # Test metadata tags feature
  metadata-tags:
    name: Metadata Tags
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) ||
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name != github.repository)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
      - id: metadata-tags
        uses: ./
        with:
          package: frontend
          build_context: frontend
          repository: bcgov/quickstart-openshift
          tags: |
            ${{ github.event.number }}
            custom-tag
          tag_fallback: test
          triggers: ('frontend/')
          # Enable metadata tags
          metadata_tags: "true"
          metadata_flavor: |
            latest=true
          metadata_tag_rules: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha

      - if: steps.metadata-tags.outputs.triggered != 'false'
        run: |
          # Verify outputs including labels
          echo "Outputs: ${{ toJSON(steps.metadata-tags.outputs) }}"
          if [ -z "${{ steps.metadata-tags.outputs.digest }}" ] || [ "${{ steps.metadata-tags.outputs.triggered }}" != "true" ]; then
            echo "Error!  Verify outputs."
            exit 1
          fi
          # Verify labels output exists when metadata_tags is enabled
          if [ -z "${{ steps.metadata-tags.outputs.labels }}" ]; then
            echo "Error! Labels output is missing when metadata_tags is enabled."
            exit 1
          fi
          echo "Metadata tags test passed!"

  results:
    name: PR Results
    needs: [advanced, build, no-attestation, single-package, metadata-tags]
    if: always()
    runs-on: ubuntu-24.04
    steps:
      # Fail if any job failed or was cancelled (but not skipped - skipped is expected for duplicate event filtering)
      - if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
        run: echo "At least one job has failed or was cancelled." && exit 1
      - run: echo "Success!"
