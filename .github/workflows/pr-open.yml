name: PR

on:
  pull_request:
  pull_request_target:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  attestations: write
  id-token: write
  packages: write

jobs:
  # QuickStart apps build from the same dirs as their Dockerfiles
  build:
    name: Build
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - id: build
        uses: ./
        with:
          package: backend
          repository: bcgov/quickstart-openshift

      - if: steps.build.outputs.skip != 'true' && steps.build.outputs.triggered != 'false'
        run: |
          # Verify outputs
          echo "Outputs: ${{ toJSON(steps.build.outputs) }}"
          if [ -z "${{ steps.build.outputs.digest }}" ]; then
            echo "Error! Verify outputs."
            exit 1
          fi

  # No attestation, no id-token, no build
  no-attestation:
    name: No Attestation
    permissions:
      attestations: none
      id-token: none
      packages: write
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - id: no-attestation
        uses: ./
        with:
          package: frontend
          build_context: frontend
          repository: bcgov/quickstart-openshift
          tags: ${{ github.event.number }}-no-attestation
          tag_fallback: test
          triggers: ('frontend/')

      - if: steps.no-attestation.outputs.skip != 'true' && steps.no-attestation.outputs.triggered != 'false'
        run: |
          # Verify outputs
          echo "Outputs: ${{ toJSON(steps.no-attestation.outputs) }}"
          if [ -z "${{ steps.no-attestation.outputs.digest }}" ]; then
            echo "Error! Verify outputs."
            exit 1
          fi

  # FOM apps build from repo root, above their Dockerfiles (extra params)
  advanced:
    name: Advanced
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - id: advanced
        uses: ./
        with:
          package: api
          build_context: .
          build_file: api/Dockerfile
          repository: bcgov/nr-fom
          tags: |
            ${{ github.event.number }}
            ${{ github.event.number }}-multiline
            pr-latest

  # Test single-package repo format (no package in path)
  single-package:
    name: Single Package
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - id: single-package
        uses: ./
        with:
          package: action-builder-ghcr
          build_context: .
          build_file: ./Dockerfile # Results in org/repo format since Dockerfile is in root
          repository: bcgov/nr-peach
          tags: |
            ${{ github.event.number }}
            single-package-test

      - if: steps.single-package.outputs.skip != 'true' && steps.single-package.outputs.triggered != 'false'
        run: |
          # Verify outputs
          echo "Outputs: ${{ toJSON(steps.single-package.outputs) }}"
          if [ -z "${{ steps.single-package.outputs.digest }}" ]; then
            echo "Error! Verify outputs."
            exit 1
          fi

  # Test metadata tags feature
  metadata-tags:
    name: Metadata Tags
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - id: metadata-tags
        uses: ./
        with:
          package: frontend
          build_context: frontend
          repository: bcgov/quickstart-openshift
          tags: |
            ${{ github.event.number }}
            custom-tag
          tag_fallback: test
          triggers: ('frontend/')
          # Enable metadata tags
          metadata_tags: "true"
          metadata_flavor: |
            latest=true
          metadata_tag_rules: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha

      - if: steps.metadata-tags.outputs.skip != 'true' && steps.metadata-tags.outputs.triggered != 'false'
        run: |
          # Verify outputs including labels
          echo "Outputs: ${{ toJSON(steps.metadata-tags.outputs) }}"
          if [ -z "${{ steps.metadata-tags.outputs.digest }}" ]; then
            echo "Error! Verify outputs."
            exit 1
          fi
          # Verify labels output exists when metadata_tags is enabled
          if [ -z "${{ steps.metadata-tags.outputs.labels }}" ]; then
            echo "Error! Labels output is missing when metadata_tags is enabled."
            exit 1
          fi
          echo "Metadata tags test passed!"

  # Test fork detection: same-repo PR under pull_request_target should skip
  # This verifies the skip logic for redundant pull_request_target events with same-repo PRs.
  # Note: Full fork PR testing (actual fork repositories) requires external fork PRs,
  # which cannot be tested in this same-repo workflow.
  fork-detection-skip:
    name: Fork Detection - Skip Same-Repo PR
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - id: fork-skip
        uses: ./
        with:
          package: frontend
          build_context: frontend
          repository: bcgov/quickstart-openshift
          tags: ${{ github.event.number }}-fork-skip
          tag_fallback: test
          triggers: ('frontend/')

      - name: Verify skip behavior
        run: |
          if [ "${{ steps.fork-skip.outputs.triggered }}" != "false" ]; then
            echo "Error! Expected triggered=false for same-repo PR under pull_request_target"
            echo "Outputs: ${{ toJSON(steps.fork-skip.outputs) }}"
            exit 1
          fi
          echo "âœ“ Correctly skipped same-repo PR under pull_request_target"

  results:
    name: PR Results
    needs: [advanced, build, no-attestation, single-package, metadata-tags, fork-detection-skip]
    if: always()
    runs-on: ubuntu-24.04
    steps:
      - if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
        run: echo "At least one job has failed or was cancelled." && exit 1
      - if: needs.fork-detection-skip.result == 'skipped' && github.event_name == 'pull_request'
        run: |
          echo "Note: fork-detection-skip job was skipped (only runs on pull_request_target events)"
      - run: echo "Success!"
